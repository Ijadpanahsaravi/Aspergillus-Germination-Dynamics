pkgs <- c("dplyr", "readxl","data.table","ggplot2","tidyr","Metrics","growthrates", "openxlsx", "zoo", "germinationmetrics", "reshape", "reshape2", "stringr")
lapply(pkgs, library, character.only = T)

csv = list.files(path = path, pattern = '*.csv')
csv_read <- function(csv){
  df <- read.csv(paste0(path, csv)) %>%
    dplyr::select(ObjectId,time,Area,Circularity, well, species)%>% # Select only the necessary columns to keep in the data frame
    mutate(filename = as.character(csv))  # Add a new column that stores the name of the CSV file as a character string
  return(df)
}
df <- do.call(rbind, lapply(csv, csv_read))# Combine the results into one data frame


t <- data %>%
  group_by(ObjectId) %>%
  mutate(
    InitialArea = first(Area, na.rm = TRUE), # Capture the initial area at t = 0, handling NA
    InitialCircularity = first(Circularity, na.rm = TRUE), # Capture the initial circularity at t = 0, handling NA
    PercentIncrease = ((Area - InitialArea) / InitialArea) * 100, # Calculate percentage increase from t = 0
    CircularityChange = abs(Circularity - InitialCircularity) / InitialCircularity)  %>% # Calculate the absolute relative change in circularity
  group_by(ObjectId) %>%
  mutate(R = case_when( CircularityChange < 0.1 & PercentIncrease < 10 ~ 1,TRUE ~ 0 ), # R: Resting phase, no significant change in area and circularity
         S = case_when(CircularityChange < 0.1 & PercentIncrease >= 10 ~ 1,TRUE ~ 0 ), # S: Swelling phase, significant change in area but not in circularity
         G = case_when(CircularityChange >= 0.1 & PercentIncrease >= 50 ~ 1 , TRUE ~ 0 ),  # G: Germ tube formation, significant change in both area and circularity
         missing = case_when(is.na(Area) & sum(S + G) == 0 ~ 1, TRUE ~ 0)) %>%
  mutate(R = na_if(R, 0), S = na_if(S, 0), G = na_if(G, 0)) %>%  # Convert zeros to NAs for clarity in the dataset
  mutate(R = na.locf0(R), S = na.locf0(S), G = na.locf0(G))%>% # Fill NA values with the last observation carried forward to maintain state
  ungroup()%>%
  mutate(status = case_when(G == 1 ~ 2, # Status 2 if germ tube formation is confirmed
                            S == 1 & is.na(G) ~ 1,TRUE ~ 0))%>% # Status 1 if only swelling is confirmed # Status 0 otherwise
  mutate(S = case_when(status > 0 ~ 1,TRUE ~ 0 ), 
         G = case_when(status > 1 ~ 1,TRUE ~ 0 ))# Update S and G columns based on final status for clarity
